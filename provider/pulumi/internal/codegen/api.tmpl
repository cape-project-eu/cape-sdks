// Code generated by gen.controlresources.go; DO NOT EDIT.

package {{.Package}}

import (
	"context"
	"fmt"
	"strings"

	"cape-project.eu/sdk-generator/provider/pulumi/config"
	"cape-project.eu/sdk-generator/provider/pulumi/secapi/{{.APIPackage}}"
	"cape-project.eu/sdk-generator/provider/pulumi/secapi/models"
	"github.com/pulumi/pulumi-go-provider/infer"
)

type api struct {
	client *{{.APIPackageID}}.ClientWithResponses
	ctx    *context.Context
	tenant string
{{- if not .WithoutWorkspace}}
	workspace string
{{- end}}
	name   string
}

func newAPI(ctx context.Context, tenant, {{- if not .WithoutWorkspace}} workspace,{{end}} name string) (*api, error) {
	config := infer.GetConfig[config.Config](ctx)
	url := config.BaseURL
	prefix := *config.{{.Package | pascalCase}}ProviderPrefix
	if prefix != "" {
		switch true {
		case strings.HasSuffix(url, "/") && strings.HasPrefix(prefix, "/"):
			url = url + prefix[1:]
		case !strings.HasSuffix(url, "/") && !strings.HasPrefix(prefix, "/"):
			url = url + "/" + prefix
		default:
			url = url + prefix
		}
	}
	client, err := {{.APIPackageID}}.NewClientWithResponses(url)
	if err != nil {
		return nil, err
	}

	return &api{
		ctx:    &ctx,
		client: client,
		tenant: tenant,
{{- if not .WithoutWorkspace}}
		workspace: workspace,
{{- end}}
		name:   name,
	}, nil
}

func (obj *api) Get() (*models.{{.Name}}, error) {
	getRes, err := obj.client.Get{{.Name}}WithResponse(*obj.ctx, obj.tenant, {{- if not .WithoutWorkspace}} obj.workspace,{{end}} obj.name)
	if err != nil {
		return nil, err
	}
	if getRes.StatusCode() != 200 {
		return nil, fmt.Errorf("unexpected status code (expected 200): %d, body: %s", getRes.StatusCode(), getRes.Body)
	}

	return getRes.JSON200, nil
}

func (obj *api) Exists() (bool, error) {
	getRes, err := obj.client.Get{{.Name}}WithResponse(*obj.ctx, obj.tenant, {{- if not .WithoutWorkspace}} obj.workspace,{{end}} obj.name)
	if err != nil {
		return false, err
	}
	return getRes.StatusCode() == 200, nil
}

func (obj *api) WaitForActive() (*models.{{.Name}}, error) {
	for {
		result, err := obj.Get()
		if err != nil {
			return nil, err
		}

		if *result.Status.State == models.ResourceStateActive {
			return result, nil
		}
	}
}

func (obj *api) Create(in models.{{.Name}}) (*models.{{.Name}}, error) {
	res, err := obj.client.CreateOrUpdate{{.Name}}WithResponse(*obj.ctx, obj.tenant, {{- if not .WithoutWorkspace}} obj.workspace,{{end}} obj.name, nil, in)
	if err != nil {
		return nil, err
	}
	if res.StatusCode() != 201 {
		return nil, fmt.Errorf("unexpected status code (expected 201): %d, body: %s", res.StatusCode(), res.Body)
	}

	return res.JSON201, nil
}

func (obj *api) Update(in models.{{.Name}}) (*models.{{.Name}}, error) {
	res, err := obj.client.CreateOrUpdate{{.Name}}WithResponse(*obj.ctx, obj.tenant, {{- if not .WithoutWorkspace}} obj.workspace,{{end}} obj.name, nil, in)
	if err != nil {
		return nil, err
	}
	if res.StatusCode() != 200 {
		return nil, fmt.Errorf("unexpected status code (expected 200): %d, body: %s", res.StatusCode(), res.Body)
	}

	return res.JSON200, nil
}

func (obj *api) Delete() error {
	res, err := obj.client.Delete{{.Name}}WithResponse(*obj.ctx, obj.tenant, {{- if not .WithoutWorkspace}} obj.workspace,{{end}} obj.name, nil)
	if err != nil {
		return err
	}
	if res.StatusCode() > 299 && res.StatusCode() != 404 {
		return fmt.Errorf("unexpected status code (expected <300 or 404): %d, body: %s", res.StatusCode(), res.Body)
	}

	return nil
}
