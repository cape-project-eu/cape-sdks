// Code generated by gen.controlresources.go; DO NOT EDIT.

package {{.Package}}

import (
	"context"
	"fmt"

	"cape-project.eu/sdk-generator/provider/pulumi/config"
	"cape-project.eu/sdk-generator/provider/pulumi/internal/schemas"
	"github.com/pulumi/pulumi-go-provider/infer"
)

func ({{.Name}}) Create(
	ctx context.Context,
	req infer.CreateRequest[{{.Name}}Args],
) (infer.CreateResponse[{{.Name}}State], error) {
	config := infer.GetConfig[config.Config](ctx)
	var tenant{{- if not .WithoutWorkspace}}, workspace{{- end}} string
	if req.Inputs.Tenant == nil {
		tenant = config.Tenant
	} else {
		tenant = *req.Inputs.Tenant
	}
{{- if not .WithoutWorkspace}}
	if req.Inputs.Workspace != nil {
		workspace = *req.Inputs.Workspace
	} else if config.Workspace != nil {
		workspace = *config.Workspace
	} else {
		return infer.CreateResponse[{{.Name}}State]{}, fmt.Errorf("workspace not given for {{.Name}} resource %s", req.Name)
	}
{{- end}}

	state := {{.Name}}State{ {{- .Name}}Args: req.Inputs}
	if req.DryRun {
{{- range .Outputs}}
		{{- if not .Optional }}
		state.{{.Name}} = {{.Type -}} {}
		{{- end}}
{{- end}}
		return infer.CreateResponse[{{.Name}}State]{
			ID:     "dryrun",
			Output: state,
		}, nil
	}

	client, err := newAPI(ctx, tenant, {{- if not .WithoutWorkspace}} workspace,{{end}} req.Name)
	if err != nil {
		return infer.CreateResponse[{{.Name}}State]{}, err
	}

	exists, err := client.Exists()
	if err != nil {
		return infer.CreateResponse[{{.Name}}State]{}, err
	}
	if exists {
		return infer.CreateResponse[{{.Name}}State]{}, fmt.Errorf("{{.Name}} with name %s already exists", req.Name)
	}

	result, err := client.Create(convertArgsToOpenAPI(req.Inputs))
	if err != nil {
		return infer.CreateResponse[{{.Name}}State]{}, err
	}

	result, err = client.WaitForActive()
	if err != nil {
		return infer.CreateResponse[{{.Name}}State]{}, err
	}

	return infer.CreateResponse[{{.Name}}State]{
		ID:     fmt.Sprintf("%s-{{if not .WithoutWorkspace}}%s-{{end}}%s-%s-%s", result.Metadata.Tenant, {{- if not .WithoutWorkspace}} result.Metadata.Workspace,{{end}} result.Metadata.Kind, result.Metadata.ApiVersion, result.Metadata.Name),
		Output: convertAPIResultToPulumiState(*result),
	}, nil
}
